<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>全国ランキング勉強時間バー（上位50人・通知改良）</title>
<style>
  body { font-family: sans-serif; background: #f7f7f7; padding: 20px; margin-bottom: 140px; }
  h1 { text-align: center; margin-bottom: 10px; }
  #myRank {
    max-width: 700px;
    margin: 0 auto 20px;
    font-weight: bold;
    font-size: 18px;
    text-align: center;
  }
  #top50Section {
    max-width: 700px;
    margin: 0 auto 40px;
  }
  #top50Section h2 {
    text-align: center;
    margin-bottom: 8px;
    font-weight: bold;
    border-bottom: 2px solid #2196f3;
    padding-bottom: 4px;
  }
  .bar-container {
    margin: 6px 0;
    font-size: 14px;
  }
  .label {
    margin-bottom: 2px;
    font-weight: bold;
  }
  .bar-bg {
    background: #ddd;
    height: 26px;
    border-radius: 4px;
    overflow: hidden;
  }
  .bar {
    height: 100%;
    line-height: 26px;
    padding-right: 8px;
    color: white;
    font-weight: bold;
    text-align: right;
    white-space: nowrap;
    transition: width 0.3s ease;
  }
  .user-bar {
    background: #2196f3;
  }
  .normal-bar {
    background: #1976d2;
  }
  #controls {
    max-width: 700px;
    margin: 0 auto 90px;
    text-align: center;
  }
  input[type=number] {
    padding: 8px;
    width: 80px;
    font-size: 16px;
    margin-right: 4px;
  }
  button {
    padding: 8px 16px;
    font-size: 16px;
    margin-left: 10px;
    cursor: pointer;
  }
  button.reset {
    background: #f44336;
    color: white;
    border: none;
  }
  #notificationContainer {
    position: fixed;
    bottom: 10px;
    left: 0;
    width: 100%;
    height: 180px;
    pointer-events: none;
    overflow: visible;
    z-index: 9999;
  }
  .notification {
    position: absolute;
    bottom: 0;
    font-weight: bold;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    color: #2196f3;
    background: rgba(33, 150, 243, 0.15);
    padding: 2px 8px;
    border-radius: 8px;
    white-space: nowrap;
    user-select: none;
    pointer-events: none;
    filter: drop-shadow(0 0 2px rgba(33, 150, 243, 0.6));
    font-size: 10px;
    animation: riseUpFade 5s linear forwards;
  }
  @keyframes riseUpFade {
    0% {
      opacity: 1;
      transform: translateY(0);
    }
    80% {
      opacity: 1;
      transform: translateY(-140px);
    }
    100% {
      opacity: 0;
      transform: translateY(-180px);
    }
  }
</style>
</head>
<body>

<h1>全国ランキング勉強時間バー（上位50人）</h1>
<div id="myRank">自分の全国ランキング: 読み込み中...</div>

<div id="top50Section">
  <h2>上位50人</h2>
  <div id="top50Bars"></div>
</div>

<div id="controls">
  <input type="number" id="addHours" placeholder="時間" min="0" step="1" />
  <span>時間</span>
  <input type="number" id="addMinutes" placeholder="分" min="0" max="59" step="1" />
  <span>分</span>
  <button onclick="addMyHours()">追加</button>
  <button onclick="resetMyHours()" class="reset">リセット</button>
  <button id="resetAllBtn" onclick="resetAllData()">全データリセット</button>
</div>

<div id="notificationContainer"></div>

<script>
const nationalUsersCount = 100000;
const myId = 49133;
const storageKey = "nationalUsersData";
const myHoursKey = "myNationalHours";

function formatTime(hours) {
  const totalSeconds = Math.floor(hours * 3600);
  const h = Math.floor(totalSeconds / 3600);
  const m = Math.floor((totalSeconds % 3600) / 60);
  const s = totalSeconds % 60;
  return `${h}時間${m}分${s}秒`;
}

let nationalUsers = [];

function loadUsers() {
  const raw = localStorage.getItem(storageKey);
  if(raw){
    try {
      const data = JSON.parse(raw);
      if(Array.isArray(data) && data.length === nationalUsersCount){
        nationalUsers = data;
        return;
      }
    } catch(e){}
  }
  nationalUsers = [];
  for(let i=1; i<=nationalUsersCount; i++){
    nationalUsers.push({id:i, hours:0});
  }
  saveUsers();
}

function saveUsers(){
  localStorage.setItem(storageKey, JSON.stringify(nationalUsers));
}

function loadMyHours(){
  const h = localStorage.getItem(myHoursKey);
  if(h) return parseFloat(h);
  return 0;
}

function saveMyHours(h){
  localStorage.setItem(myHoursKey, h.toString());
}

function updateMyData(){
  const idx = nationalUsers.findIndex(u => u.id === myId);
  if(idx>=0){
    nationalUsers[idx].hours = myHours;
  } else {
    nationalUsers.push({id: myId, hours: myHours});
  }
}

function updateRanking(){
  nationalUsers.sort((a,b) => b.hours - a.hours);
  nationalUsers.forEach((u,i) => u.rank = i+1);
}

function getMyRank(){
  const me = nationalUsers.find(u => u.id === myId);
  return me ? me.rank : -1;
}

function createBar(user, maxHours){
  const widthPercent = (user.hours / maxHours) * 100;
  const barDiv = document.createElement("div");
  barDiv.className = "bar-container";

  const labelDiv = document.createElement("div");
  labelDiv.className = "label";
  labelDiv.textContent = `#${user.rank} 番号:${user.id}`;

  const barBg = document.createElement("div");
  barBg.className = "bar-bg";

  const bar = document.createElement("div");
  bar.className = (user.id === myId) ? "bar user-bar" : "bar normal-bar";
  bar.style.width = widthPercent + "%";
  bar.textContent = formatTime(user.hours);

  barBg.appendChild(bar);
  barDiv.appendChild(labelDiv);
  barDiv.appendChild(barBg);
  return barDiv;
}

function renderTop50Bars(){
  const container = document.getElementById("top50Bars");
  container.innerHTML = "";
  const maxHours = nationalUsers[0]?.hours || 1;
  for(let i=0; i<50; i++){
    const user = nationalUsers[i];
    if(!user) break;
    container.appendChild(createBar(user, maxHours));
  }
}

const notificationContainer = document.getElementById("notificationContainer");

function showNotification(text) {
  const div = document.createElement("div");
  div.className = "notification";

  // ランダムなX座標（0%〜90%）
  const randomX = Math.random() * 90;
  div.style.left = randomX + "%";

  div.textContent = text;
  notificationContainer.appendChild(div);

  // 5秒後に消す（CSSアニメーション5秒）
  setTimeout(() => {
    if(div.parentNode) div.parentNode.removeChild(div);
  }, 5000);
}

function isWeekend(){
  const d = new Date();
  const day = d.getDay(); // 0=日曜,6=土曜
  return (day === 0 || day === 6);
}

const MIN_INC = 0.1;   // 0.5時間(30分)
const MAX_INC = 0.3;   // 1.5時間(90分)

function generateBatchNotifications(){
  const weekend = isWeekend();
  const notifyCount = weekend ? 35 : 20; // 休日7回 平日4回

  for(let i=0; i<notifyCount; i++){
    const inc = Math.random() * (MAX_INC - MIN_INC) + MIN_INC;
    const idx = Math.floor(Math.random() * nationalUsersCount);
    const user = nationalUsers[idx];
    if(!user) continue;
    const oldRank = user.rank;
    user.hours += inc;

    showNotification(`#${oldRank} 番号${user.id}が${inc.toFixed(2)}時間勉強`);
  }
}

let myHours = loadMyHours();

function mainLoop(){
  updateMyData();
  updateRanking();
  renderTop50Bars();
  updateMyRankDisplay();
  saveUsers();
}

function updateMyRankDisplay(){
  const rank = getMyRank();
  document.getElementById("myRank").textContent =
    `自分の全国ランキング: ${rank.toLocaleString()}位 / ${nationalUsersCount.toLocaleString()}人中 (${formatTime(myHours)})`;
}

function addMyHours(){
  const h = parseInt(document.getElementById("addHours").value, 10);
  const m = parseInt(document.getElementById("addMinutes").value, 10);
  const hoursToAdd = (isNaN(h) ? 0 : h) + (isNaN(m) ? 0 : m / 60);
  if(hoursToAdd > 0){
    myHours += hoursToAdd;
    saveMyHours(myHours);
    updateMyData();
    updateRanking();
    renderTop50Bars();
    updateMyRankDisplay();
    document.getElementById("addHours").value = "";
    document.getElementById("addMinutes").value = "";
  }
}

function resetMyHours(){
  myHours = 0;
  saveMyHours(myHours);
  updateMyData();
  updateRanking();
  renderTop50Bars();
  updateMyRankDisplay();
}

function resetAllData(){
  if(confirm("全データをリセットして初期状態に戻しますか？")){
    localStorage.removeItem(storageKey);
    localStorage.removeItem(myHoursKey);
    location.reload();
  }
}

loadUsers();
updateMyData();
updateRanking();
renderTop50Bars();
updateMyRankDisplay();

setInterval(generateBatchNotifications, 1000);
setInterval(mainLoop, 1000);

</script>

</body>
</html>
