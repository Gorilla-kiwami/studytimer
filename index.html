<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>勉強時間比較バー（曜日別ペース固定・分単位入力対応）</title>
<style>
  body { font-family: sans-serif; background: #f7f7f7; padding: 20px; }
  h1 { text-align: center; margin-bottom: 30px; }
  #bars {
    max-width: 600px;
    margin: 0 auto 40px;
  }
  .bar-container {
    margin: 10px 0;
  }
  .label {
    margin-bottom: 5px;
    font-weight: bold;
  }
  .bar-bg {
    background: #ddd;
    height: 30px;
    border-radius: 5px;
    overflow: hidden;
  }
  .bar {
    height: 100%;
    line-height: 30px;
    padding-right: 10px;
    color: white;
    font-weight: bold;
    text-align: right;
    white-space: nowrap;
    transition: width 0.3s ease;
  }
  .risan1 { background: #d32f2f; }
  .risan2 { background: #b71c1c; }
  .tokai1 { background: #388e3c; }
  .tokai2 { background: #2e7d32; }
  .tokai3 { background: #1b5e20; }
  .normal { background: #1976d2; }
  .mine { background: #2196f3; }
  #controls {
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
  }
  input[type=number] {
    padding: 8px;
    width: 80px;
    font-size: 16px;
    margin-right: 4px;
  }
  button {
    padding: 8px 16px;
    font-size: 16px;
    margin-left: 10px;
    cursor: pointer;
  }
  button.reset {
    background: #f44336;
    color: white;
    border: none;
  }
</style>
</head>
<body>
<h1>勉強時間比較バー（曜日別ペース固定・分単位入力対応）</h1>

<div id="bars"></div>

<div id="controls">
  <input type="number" id="addHours" placeholder="時間" min="0" step="1" />
  <span>時間</span>
  <input type="number" id="addMinutes" placeholder="分" min="0" max="59" step="1" />
  <span>分</span>
  <button onclick="addMyHours()">追加</button>
  <button onclick="resetMyHours()" class="reset">リセット</button>
</div>

<script>
// 開始日時（4月1日 0:00）
const startDate = new Date(new Date().getFullYear(), 3, 1);
const secondsPerDay = 86400;

// メンバー一覧（固定ペース・平日・土日）
const members = [
  { name: "理三志望1", weekdayRate: 5, weekendRate: 10, className: "risan1" },
  { name: "理三志望2", weekdayRate: 4, weekendRate: 8, className: "risan2" },
  { name: "東海生1",   weekdayRate: 4, weekendRate: 7, className: "tokai1" },
  { name: "東海生2",   weekdayRate: 3, weekendRate: 7, className: "tokai2" },
  { name: "東海生3",   weekdayRate: 2, weekendRate: 5, className: "tokai3" },
  { name: "普通の中学生", weekdayRate: 1, weekendRate: 3, className: "normal" },
  { name: "あなた",     weekdayRate: 0, weekendRate: 0, className: "mine" }
];

// 自分の初期時間（localStorageから）
let myHours = parseFloat(localStorage.getItem("myHours")) || 0;

// 曜日判定（日曜=0〜土曜=6）
function isWeekend(date) {
  const day = date.getDay();
  return day === 0 || day === 6;
}

// 時間表示フォーマット（秒まで）
function formatTime(hours) {
  const totalSeconds = Math.floor(hours * 3600);
  const h = Math.floor(totalSeconds / 3600);
  const m = Math.floor((totalSeconds % 3600) / 60);
  const s = totalSeconds % 60;
  return `${h}時間${m}分${s}秒`;
}

// 4/1から今日までの日毎に計算して初期時間セット
function initHoursForPlayer(player) {
  let totalHours = 0;
  let current = new Date(startDate);
  const now = new Date();

  while (current < now) {
    const dayEnd = new Date(current);
    dayEnd.setHours(23,59,59,999);
    const secondsInDay = (dayEnd < now ? dayEnd : now) - current;
    const secondsInDayNum = secondsInDay / 1000;
    const weekend = isWeekend(current);
    const rate = weekend ? player.weekendRate / secondsPerDay : player.weekdayRate / secondsPerDay;
    totalHours += rate * secondsInDayNum;
    current = new Date(dayEnd.getTime() + 1);
  }
  return totalHours;
}

// プレイヤー配列作成
let players = members.map(m => ({
  name: m.name,
  weekdayRate: m.weekdayRate,
  weekendRate: m.weekendRate,
  className: m.className,
  hours: 0,
  isUser: m.name === "あなた"
}));

// 自分の時間初期化
players.forEach(p => {
  if (p.isUser) p.hours = myHours;
});

// 他の人は4/1からの経過時間に応じて初期時間セット
players.forEach(p => {
  if (!p.isUser) {
    p.hours = initHoursForPlayer(p);
  }
});

// 現在日時に応じてペースを返す
function getCurrentRate(player) {
  return isWeekend(new Date()) ? player.weekendRate / secondsPerDay : player.weekdayRate / secondsPerDay;
}

// 最大時間取得
function getMaxHours() {
  let max = 1;
  players.forEach(p => {
    if (p.hours > max) max = p.hours;
  });
  return max;
}

// バー描画＆並び替え
function renderBars() {
  players.sort((a, b) => b.hours - a.hours);
  const maxHours = getMaxHours();
  const container = document.getElementById("bars");
  container.innerHTML = "";
  players.forEach(p => {
    const widthPercent = (p.hours / maxHours) * 100;
    const barDiv = document.createElement("div");
    barDiv.className = "bar-container";
    const labelDiv = document.createElement("div");
    labelDiv.className = "label";
    labelDiv.textContent = p.name;
    const barBg = document.createElement("div");
    barBg.className = "bar-bg";
    const bar = document.createElement("div");
    bar.className = `bar ${p.className}`;
    bar.style.width = widthPercent + "%";
    bar.textContent = formatTime(p.hours);
    barBg.appendChild(bar);
    barDiv.appendChild(labelDiv);
    barDiv.appendChild(barBg);
    container.appendChild(barDiv);
  });
}

// 自分の勉強時間追加（時間＋分）
function addMyHours() {
  const h = parseInt(document.getElementById("addHours").value, 10);
  const m = parseInt(document.getElementById("addMinutes").value, 10);
  const hoursToAdd = (isNaN(h) ? 0 : h) + (isNaN(m) ? 0 : m / 60);
  if (hoursToAdd > 0) {
    const me = players.find(p => p.isUser);
    me.hours += hoursToAdd;
    myHours = me.hours;
    localStorage.setItem("myHours", myHours);
    document.getElementById("addHours").value = "";
    document.getElementById("addMinutes").value = "";
    renderBars();
  }
}

// 自分の勉強時間リセット
function resetMyHours() {
  if (confirm("本当に自分の勉強時間をリセットしますか？")) {
    const me = players.find(p => p.isUser);
    me.hours = 0;
    myHours = 0;
    localStorage.setItem("myHours", 0);
    renderBars();
  }
}

// 1秒ごとのリアルタイム増加＆描画更新
setInterval(() => {
  players.forEach(p => {
    if (!p.isUser) {
      p.hours += getCurrentRate(p);
    }
  });
  renderBars();
}, 1000);

// 初回描画
renderBars();
</script>
</body>
</html>
