<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>勉強タイマー＋今日の勉強時間</title>
<style>
  body { font-family: sans-serif; text-align: center; margin-top: 40px; }
  #remainingTime { font-size: 3em; margin-bottom: 10px; }
  button { font-size: 1.2em; margin: 5px; padding: 10px 20px; }
  #status, #todayTotal, #currentDateTime { margin-top: 10px; font-size: 1.1em; }
</style>
</head>
<body>

<h1>勉強タイマー</h1>
<div id="remainingTime">--:--:--</div>
<button id="startBtn">勉強開始</button>
<button id="stopBtn">勉強停止</button>
<div id="status"></div>
<div id="todayTotal">今日の勉強時間: 00:00:00</div>
<div id="currentDateTime">--/-- --:--:--</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCEFObhHlcSRSpaY541SzU-7OXzEcH0AOY",
  authDomain: "study-timer-gorilla.firebaseapp.com",
  databaseURL: "https://study-timer-gorilla-default-rtdb.firebaseio.com",
  projectId: "study-timer-gorilla",
  storageBucket: "study-timer-gorilla.firebasestorage.app",
  messagingSenderId: "676633463961",
  appId: "1:676633463961:web:1fdb4fe161d6d448043c08",
  measurementId: "G-07DN406DG2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const MAX_TIME = 180 * 60; // 3時間（秒）
let remaining = MAX_TIME;
let studying = false;
let lastUpdate = Date.now();
let todayStudyTotal = 0;
let todayDateStr = "";  // 今日の日付YYYY-MM-DD

let userId = localStorage.getItem("userId");
if (!userId) {
  userId = Math.random().toString(36).slice(2);
  localStorage.setItem("userId", userId);
}

const remainingTimeElem = document.getElementById("remainingTime");
const statusElem = document.getElementById("status");
const todayTotalElem = document.getElementById("todayTotal");
const currentDateTimeElem = document.getElementById("currentDateTime");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");

function formatTime(sec) {
  const h = String(Math.floor(sec / 3600)).padStart(2, "0");
  const m = String(Math.floor((sec % 3600) / 60)).padStart(2, "0");
  const s = String(sec % 60).padStart(2, "0");
  return `${h}:${m}:${s}`;
}

function getTodayStr(date = new Date()) {
  return date.toISOString().slice(0, 10);
}

function updateDisplay() {
  remainingTimeElem.textContent = formatTime(remaining);
  statusElem.textContent = studying ? "勉強中" : "勉強停止中";
  todayTotalElem.textContent = `今日の勉強時間: ${formatTime(todayStudyTotal)}`;
  const now = new Date();
  currentDateTimeElem.textContent = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,"0")}/${String(now.getDate()).padStart(2,"0")} ${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}:${String(now.getSeconds()).padStart(2,"0")}`;
}

// 時間帯制限なしで常にtrue（動作確認用）
function isActiveTime() {
  return true;
}

async function loadTimer() {
  const docRef = doc(db, "studyTimers", userId);
  const docSnap = await getDoc(docRef);
  if (docSnap.exists()) {
    const data = docSnap.data();
    remaining = data.remaining;
    studying = data.studying;
    lastUpdate = data.lastUpdated;
    // 今日の日付と保存された日付を比べる
    todayDateStr = getTodayStr();
    if (data.todayDate !== todayDateStr) {
      todayStudyTotal = 0; // 日付違えばリセット
    } else {
      todayStudyTotal = data.todayStudyTotal || 0;
    }
  } else {
    remaining = MAX_TIME;
    studying = false;
    lastUpdate = Date.now();
    todayDateStr = getTodayStr();
    todayStudyTotal = 0;
    await setDoc(docRef, {
      remaining,
      studying,
      lastUpdated,
      todayDate: todayDateStr,
      todayStudyTotal
    });
  }
  updateDisplay();
  isLoaded = true;
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(updateTimer, 1000);
}

async function saveTimer() {
  const docRef = doc(db, "studyTimers", userId);
  await updateDoc(docRef, {
    remaining,
    studying,
    lastUpdated,
    todayDate: todayDateStr,
    todayStudyTotal
  });
}

let timerInterval = null;
let isLoaded = false;

function updateTimer() {
  if (!isLoaded) return;
  if (!isActiveTime() || remaining <= 0) {
    updateDisplay();
    return;
  }
  const now = Date.now();
  const diffSec = Math.floor((now - lastUpdate) / 1000);
  if (diffSec >= 1) {
    if (studying) {
      remaining += diffSec;
      if (remaining > MAX_TIME) remaining = MAX_TIME;
      todayStudyTotal += diffSec; // 勉強時間も増やす
    } else {
      remaining -= diffSec * 2;
      if (remaining < 0) remaining = 0;
    }
    // 日付が変わったら勉強時間リセット
    const newDateStr = getTodayStr();
    if (newDateStr !== todayDateStr) {
      todayDateStr = newDateStr;
      todayStudyTotal = 0;
    }
    lastUpdate = now;
    updateDisplay();
    saveTimer();
  }
}

startBtn.onclick = () => {
  studying = true;
  lastUpdate = Date.now();
  updateDisplay();
  saveTimer();
};

stopBtn.onclick = () => {
  studying = false;
  lastUpdate = Date.now();
  updateDisplay();
  saveTimer();
};

loadTimer();

setInterval(() => {
  const now = new Date();
  currentDateTimeElem.textContent = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,"0")}/${String(now.getDate()).padStart(2,"0")} ${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}:${String(now.getSeconds()).padStart(2,"0")}`;
}, 1000);

</script>

</body>
</html>
